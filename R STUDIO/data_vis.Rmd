---
title: "Data visulaization gdx: tryal"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

## 0. Settings

```{r, warning=FALSE, message=FALSE}
#setwd("C:/Users/modin/Desktop/Ettore/UNIVERSITA/ECC_GAMS/R STUDIO")
rm( list = ls() )

list.files()
graphics.off() # chiude tutti i device grafici
cat("\014") #pulisci console

library(tidyverse)
library(gdxtools)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggrepel)
library(ggsci) # scientific colors
library(viridis) #looks good and includes many options
library(RColorBrewer) # wide choice
library(countrycode) # Country name tools

```

# Extract and combine data from different gdx
```{r}
path <- "../../witchmodel"


files <- list.files(path,pattern = ".gdx")
myfiles <- file.path(path, files)
myfiles = myfiles %>% str_subset(pattern = "results.*\\.gdx")
myfiles
myfiles=myfiles[c(2,5,6)]
myfiles

```

# TIME
```{r}
tstep = 5
first_year = 2000
max_year = 2150
```

# battery cost
```{r}
res <- batch_extract(variables, files = myfiles) # load GHG emissions
plot(res$battery_cost[,c(1:2)],pch = 16)
res$battery_cost[,c(1:2)]
res$battery_cost[which(res$battery_cost[,2]==min(res$battery_cost[,2])),1]

t0 = 1
t1 = 30
y_t0=res$battery_cost[which(res$battery_cost[,1]==t0),2]
y_t1=res$battery_cost[which(res$battery_cost[,1]==t1),2]

x=seq(from=1,to=30,length.out=30)
y = res$battery_cost[,2]
model <- lm(y~exp(1/x))
summary(model)

#use the model to predict the y-values based on the x-values
yy=predict(model,newdata = list(x=seq(30), interval="confidence"))

#add the fitted regression line to the plot (lwd specifies the width of the line)
matlines(x,y_t1+100*exp(1/x))
#points(x,y_t1-b/log(x),col = "gold",pch = 16)

```

#I_EN
```{r}
variable = c("I_EN")
res <- batch_extract(variable, files = myfiles) 
res = res[[variable]]
res

res = res[which(res$jinv == "trad_cars" & res$n %in% c("usa","europe","china")),]
```

#K_EN
```{r}
variable = c("K_EN")
res <- batch_extract(variable, files = myfiles) 
res = res[[variable]]
res

res = res[which(res$jreal == "battery" & res$n %in% c("usa","europe","china")),]
res
```

#UTILITY
```{r}
variable = c("UTILITY")
res <- batch_extract(variable, files = myfiles) 
res = res[[variable]]
res

base = 1
new = 3
paste0(round((1-res$value[base]/res$value[new])*100,2),"%")

```



```{r}
variable = c("MCOST_INV")
res <- batch_extract(variable, files = myfiles) 
res = res[[variable]]
res

res = res[which(res$jreal == "battery" & res$n %in% c("usa","europe","china")),]
res
```



# battery cost
```{r}
variable = c("battery_cost_new")

res <- batch_extract(variable, files = myfiles) 
res = res[[variable]]
res

#res = res[which( res$n %in% c("china","usa")),]

```

# WCUM battery
```{r}
variable = c("wcum")

res <- batch_extract(variable, files = myfiles) 
res = res[[variable]]
res

res = res[res$V1=="battery",]
gdxs = unique(res$gdx)
data_diff = res[res$gdx==gdxs[2],"value"]-res[res$gdx==gdxs[1],"value"]
data_perc = data_diff/res[res$gdx==gdxs[1],"value"]
plot(data_diff,type="b",pch=16)
plot(data_perc,type="b",pch=16)
```

```{r}
v = variable # rename for semplicity

data = res %>% as_tibble()

data <- data %>%
# Transform time period into year, t0 and tsep could be different
mutate(year = as.numeric(t) * tstep + first_year) %>% 
# Transform the filename into a scenario name
## would be cool to subdivide each sub scenario indipendently but don't know if it's even worth it
## NB: save different analysis in different folders
mutate(scen = basename(gdx)) %>% 
mutate(scen = str_replace(scen, ".gdx", "")) %>%
mutate(scen = str_replace(scen, "results_", ""))

levs = unique(data$scen)
data <- data %>% mutate(scen = factor(scen, levels = levs))


## group regiondata into worlddata
#data <- data %>% group_by(scen,year) %>% summarise(value = sum(value))


ggplot(data %>% filter(year <= max_year),
      aes(x = year, y = value, color = scen)) +
  
geom_line() +

#facet_wrap(~n, ncol = 3, scales='free') +
  
geom_point() + # NEW GEOMETRY, SAME DATA AND MAPPING

#geom_hline(yintercept = 0, color = 'Black', size = 0.8) +
  
labs(x = "", y = v, title = v) +
  
theme_bw() +
theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  
scale_x_continuous(limits=c(first_year+tstep, max_year),
                    breaks=seq(first_year+tstep, max_year,by = 10)) +
  
#scale_y_continuous(limits=c(-5, 50)) +
  
#scale_color_discrete(name = "Scenario")
scale_color_viridis(name = "Scenario",discrete = TRUE, option = "D")
```
<<<<<<< Updated upstream
```{r}
mutate(scen = basename(gdx)) %>% 
mutate(scen = str_replace(scen, ".gdx", "")) %>%
mutate(scen = str_replace(scen, "results_", ""))
levs = unique(data$scen)
data <- data %>% mutate(scen = factor(scen, levels = levs))
## group regiondata into worlddata
#data <- data %>% group_by(scen,year) %>% summarise(value = sum(value))
y_up <- data[data$scen=='ssp2_bau',]$value  
y_low <- data[data$scen=='ssp2_ctax',]$value
x <- data$year[1:30]
df_combined <- data.frame(x, y_up, y_low)
# Create the plot
ggplot() +
  geom_ribbon(data = df_combined, aes(x = x, ymin = y_low, ymax = y_up), 
              fill = "blue", alpha = 0.3) +
  geom_line(data = df_combined, aes(x = x, y = y_up), color = "red") +
  geom_line(data = df_combined, aes(x = x, y = y_low), color = "green") +
  geom_point() + # NEW GEOMETRY, SAME DATA AND MAPPING
  labs(x = "", y = v, title = v) +
  #theme_bw() +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_continuous(limits=c(first_year+tstep, max_year),
                    breaks=seq(first_year+tstep, max_year,by = 10)) +
  scale_color_manual(values = c("red", "green"), labels = c("ssp2_bau", "ssp2_ctax")) +
  theme(legend.position = "right")
```
# area between curves
```{r}
variable = c("Q_EMI")
res <- batch_extract(variable, files = myfiles) 
res = res[[variable]]
res
res = res[which(res$e == "co2" & res$n %in% c("europe")),]
```
```{r}
v = variable # rename for semplicity
data = res %>% as_tibble()
data <- data %>%
# Transform time period into year, t0 and tsep could be different
mutate(year = as.numeric(t) * tstep + first_year) %>% 
# Transform the filename into a scenario name
mutate(scen = basename(gdx)) %>% 
mutate(scen = str_replace(scen, ".gdx", "")) %>%
mutate(scen = str_replace(scen, "results_", ""))
levs = unique(data$scen)
data <- data %>% mutate(scen = factor(scen, levels = levs))
## group regiondata into worlddata
#data <- data %>% group_by(scen,year) %>% summarise(value = sum(value))
y_up <- data[data$scen=='ssp2_bau',]$value  
y_low <- data[data$scen=='ssp2_ctax',]$value
x <- data$year[1:30]
df_combined <- data.frame(x, y_up, y_low)
# Create the plot
ggplot() +
  geom_ribbon(data = df_combined, aes(x = x, ymin = y_low, ymax = y_up), 
              fill = "blue", alpha = 0.3) +
  geom_line(data = df_combined, aes(x = x, y = y_up), color = "red") +
  geom_line(data = df_combined, aes(x = x, y = y_low), color = "green") +
  geom_point() + # NEW GEOMETRY, SAME DATA AND MAPPING
  labs(x = "", y = v, title = v) +
  #theme_bw() +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_continuous(limits=c(first_year+tstep, max_year),
                    breaks=seq(first_year+tstep, max_year,by = 10)) +
  scale_color_manual(values = c("red", "green"), labels = c("ssp2_bau", "ssp2_ctax")) +
  theme(legend.position = "right")
```


# world visual
```{r}
# import the WITCH model regional definition
wreg <- read_csv('mapwitch17.csv')
# transforms ISO codes into country names
wreg <- wreg %>% mutate(region = countrycode(ISO, origin = 'iso3c', destination = 'country.name'))
# Correcting some mismatches
#wreg[ISO ='GBR']$region = 'UK'
#wreg[ISO ='USA']$region = 'USA'
wreg

world <- ne_countries(scale = "small", returnclass = "sf")
world <- subset(world,!adm0_a3 %in% c("ATA","FJI"))
# merge the WITCH regional definition with the world map
world <- merge(world,wreg, by.x = "adm0_a3", by.y = "ISO")



# merge with the emission data.frame
world0 <- merge(world,res %>% filter(t == 30), by = "n", allow.cartesian=TRUE)
# Use a better projection 'equal projection'
target_crs <- '+proj=eqearth +wktext'
world1 <- st_transform(world0, crs = target_crs)

ggplot(data = world1) +
  
geom_sf(aes(fill = value)) +
  
coord_sf(datum = target_crs, expand = FALSE, clip = "off") +
  
scale_fill_distiller(name = "CO2 emission\nreduction\n[GtCO2]",
                     palette ="RdYlGn", direction = -1) +
theme_void()
```





