---
title: "Data visulaization gdx: tryal"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

## 0. Settings

```{r, warning=FALSE, message=FALSE}
#setwd("C:/Users/modin/Desktop/Ettore/UNIVERSITA/ECC_GAMS/R STUDIO")
rm( list = ls() )

list.files()
graphics.off() # chiude tutti i device grafici
cat("\014") #pulisci console

library(tidyverse)
library(gdxtools)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggrepel)
library(ggsci) # scientific colors
library(viridis) #looks good and includes many options
library(RColorBrewer) # wide choice
library(countrycode) # Country name tools

```

# Extract and combine data from different gdx
```{r}
path <- "../../witchmodel"


files <- list.files(path,pattern = ".gdx")
myfiles <- file.path(path, files)
myfiles = myfiles %>% str_subset(pattern = "results.*\\.gdx")
myfiles
myfiles=myfiles[c(1)]
myfiles

```

# TIME
```{r}
tstep = 5
first_year = 2000
max_year = 2150
```

# one value
### UTILITY
```{r}
variable = c("UTILITY")
res <- batch_extract(variable, files = myfiles) 
res = res[[variable]]
res

base = 1
new = 3
paste0(round((1-res$value[base]/res$value[new])*100,2),"%")

```






# t
### battery_cost, emi_bio_harv
```{r}
variable = c("battery_cost")

res <- batch_extract(variable, files = myfiles) 
res = res[[variable]]
res

#res = res[which( res$n %in% c("china","usa")),]

```

## V1-t-n
### WCUM battery
```{r}
variable = c("wcum")

res <- batch_extract(variable, files = myfiles) 
res = res[[variable]]
res

res = res[res$V1=="battery",]
gdxs = unique(res$gdx)
data_diff = res[res$gdx==gdxs[2],"value"]-res[res$gdx==gdxs[1],"value"]
data_perc = data_diff/res[res$gdx==gdxs[1],"value"]
plot(data_diff,type="b",pch=16)
plot(data_perc,type="b",pch=16)
```


# fuel-t
### FPRICE
```{r}
variable = c("FPRICE")
res <- batch_extract(variable, files = myfiles) 
res = res[[variable]]
res
 
```


# t-ntpes
### I_EN_GRID, K_EN_GRID, battery_cost_new, co2_transport,
```{r}
variable = c("I_EN_GRID")
res <- batch_extract(variable, files = myfiles) 
res = res[[variable]]
res
 
```
# X-t-n

```{r}
vars = c("I_EN", "Q_EN", "MCOST_INV", "K_EN","Q_EMI", "BAU_Q_EMI", 
         "W_EMI","Q_FUEL", "COST_FUEL","MCOST_FUEL","I_OUT", "Q_EMI_OUT",
         "Q_OUT", "Q_EMI_OUT","Q_OUT","I_RD","TEMP")

vars

variable = vars[1]
res <- batch_extract(variable, files = myfiles) 
res = res[[variable]] # move from list to dataframe

# group by region
res <- res %>%
group_by(scen,year) %>%
summarise(value = sum(value))
res
 
```



## jinv-t-n
### I_EN
(trad_cars, hybrid, plg_hybrid, edv; elwindon, elwindoff, elpv; ???)
```{r}
res = res[which(res$jinv == "trad_cars" & res$n %in% c("usa","europe","china")),]
```

## j-t-n
### Q_EN
trad_cars, hybrid, plg_hybrid, edv; elwindon, elwindoff, elpv; ???)
```{r}
res = res[which( res$n %in% c("china","usa")),]
```
## jreal -t-n
### MCOST_INV, K_EN
trad_cars, hybrid, plg_hybrid, edv; elwindon, elwindoff, elpv;
```{r}
res = res[which(res$jreal == "battery" & res$n %in% c("usa","europe","china")),]
```

## e-t-n
### Q_EMI, BAU_Q_EMI, W_EMI

```{r}
res
```

## fuel -t -n 
### Q_FUEL, COST_FUEL,MCOST_FUEL
trbiofuel; advbiofuel; ?
```{r}
res
```

## f-t-n
### I_OUT: oil, Q_EMI_OUT, Q_OUT, Q_EMI_OUT,Q_OUT
```{r}
res
```
## rd-t-n
### I_RD: battery, K_RD
```{r}
res
```
## m-t-n
### TEMP 
```{r}
res
```

# X-Y-t-n

```{r}
vars2 = c("Q_IN","WCUM_EMI","W_E","QEL_OUT")
```

## fuel-jfed-t-n
### Q_IN
(trad_cars, hybrid, plg_hybrid, edv; elwindon, elwindoff, elpv; ???)
```{r}
res
```
## e-m-t-n
### WCUM_EMI,W_EMI
```{r}
res
```
## el_out-ices_el-t-n
### QEL_OUT
```{r}
res
```


# ###########################################################
# MAIN PLOTTER
```{r}
v = variable # rename for semplicity
data = res %>% as_tibble()

data <- data %>%
# Transform time period into year, t0 and tsep could be different
mutate(year = as.numeric(t) * tstep + first_year) %>% 
# Transform the filename into a scenario name
## would be cool to subdivide each sub scenario indipendently but don't know if it's even worth it
## NB: save different analysis in different folders
mutate(scen = basename(gdx)) %>% 
mutate(scen = str_replace(scen, ".gdx", "")) %>%
mutate(scen = str_replace(scen, "results_", ""))

levs = unique(data$scen)
data <- data %>% mutate(scen = factor(scen, levels = levs))


## group regiondata into worlddata
#data <- data %>% group_by(scen,year) %>% summarise(value = sum(value))


ggplot(data %>% filter(year <= max_year),
      aes(x = year, y = value, color = scen)) +
  
geom_line() +

#facet_wrap(~n, ncol = 3, scales='free') +
  
geom_point() + # NEW GEOMETRY, SAME DATA AND MAPPING

#geom_hline(yintercept = 0, color = 'Black', size = 0.8) +
  
labs(x = "", y = v, title = v) +
  
theme_bw() +
theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  
scale_x_continuous(limits=c(first_year+tstep, max_year),
                    breaks=seq(first_year+tstep, max_year,by = 10)) +
  
#scale_y_continuous(limits=c(-5, 50)) +
  
#scale_color_discrete(name = "Scenario")
scale_color_viridis(name = "Scenario",discrete = TRUE, option = "D")
```

# area between curves
```{r}
v = variable # rename for semplicity

data = res %>% as_tibble()
data <- data %>%
mutate(scen = basename(gdx)) %>% 
mutate(scen = str_replace(scen, ".gdx", "")) %>%
mutate(scen = str_replace(scen, "results_", ""))
levs = unique(data$scen)
data <- data %>% mutate(scen = factor(scen, levels = levs))

## group regiondata into worlddata
#data <- data %>% group_by(scen,year) %>% summarise(value = sum(value))
y_up <- data[data$scen=='ssp2_bau',]$value  
y_low <- data[data$scen=='ssp2_ctax',]$value
x <- seq(2005,2150,by=5)
df_combined <- data.frame(x, y_up, y_low)

# Create the plot
ggplot() +
  geom_ribbon(data = df_combined, aes(x = x, ymin = y_low, ymax = y_up), 
              fill = "blue", alpha = 0.3) +
  geom_line(data = df_combined, aes(x = x, y = y_up), color = "red") +
  geom_line(data = df_combined, aes(x = x, y = y_low), color = "green") +
  geom_point() + # NEW GEOMETRY, SAME DATA AND MAPPING
  labs(x = "", y = v, title = v) +
  #theme_bw() +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_continuous(limits=c(first_year+tstep, max_year),
                    breaks=seq(first_year+tstep, max_year,by = 10)) +
  scale_color_manual(values = c("red", "green"), labels = c("ssp2_bau", "ssp2_ctax")) +
  theme(legend.position = "right")
```

# world visual-battery_cost
```{r}
# import the WITCH model regional definition
wreg <- read_csv('mapwitch17.csv')
# transforms ISO codes into country names
wreg <- wreg %>% mutate(region = countrycode(ISO, origin = 'iso3c', destination = 'country.name'))
# Correcting some mismatches
#wreg[ISO ='GBR']$region = 'UK'
#wreg[ISO ='USA']$region = 'USA'
wreg

world <- ne_countries(scale = "small", returnclass = "sf")
world <- subset(world,!adm0_a3 %in% c("ATA","FJI"))
# merge the WITCH regional definition with the world map
world <- merge(world,wreg, by.x = "adm0_a3", by.y = "ISO")



# merge with the emission data.frame
world0 <- merge(world,res %>% filter(t == 30), by = "n", allow.cartesian=TRUE)
world1 <- st_transform(world0, crs = target_crs)

# Use a better projection 'equal projection'
target_crs <- '+proj=eqearth +wktext'
my_palette <- c("red", "green")

# Create a new variable indicating whether value is higher than 700
world1$color_category <- ifelse(world1$value > 700, "In posess of rare material", "No rare materials")


```


```{r}

# Plot the map with discrete colors
ggplot(data = world1) +
  geom_sf(aes(fill = color_category)) +
  coord_sf(datum = target_crs, expand = FALSE, clip = "off") +
  scale_fill_manual(name = "Battery Cost",
                    values = setNames(my_palette, c("In posess of rare material", "No rare materials")),
                    guide = guide_legend(title = "Battery Cost")) +
  theme_void()
```





